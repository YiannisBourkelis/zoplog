#!/bin/bash

# Simple DNS dispatcher script for ZopLog bridge setup
# Sets DNS to the internet gateway IP automatically

INTERFACE="$1"
STATUS="$2"

# Only act on br-zoplog
if [ "$INTERFACE" != "br-zoplog" ]; then
    exit 0
fi

# React on network events
case "$STATUS" in
    up|dhcp4-change|connectivity-change|reapply) ;;
    *) exit 0 ;;
esac

# Get the default gateway IP (internet router)
GATEWAY_IP=$(ip route show default | awk '/default/ {print $3; exit}')

if [ -n "$GATEWAY_IP" ]; then
    # Set gateway IP as the only DNS server
    echo "# Generated by zoplog-dns-dispatcher" > /etc/resolv.conf
    echo "nameserver $GATEWAY_IP" >> /etc/resolv.conf
    
    logger "zoplog-dispatcher: Set DNS to gateway $GATEWAY_IP for $INTERFACE"
else
    logger "zoplog-dispatcher: No default gateway found for $INTERFACE"
fi

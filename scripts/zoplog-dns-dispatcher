#!/bin/bash

# ZopLog DNS Dispatcher Script
# This script automatically updates /etc/resolv.conf with the current default gateway IP
# as the DNS server. This ensures that DNS resolution works properly on the ZopLog system
# itself, especially when the internet gateway IP changes.
#
# The script monitors ethernet interfaces (eth*, enp*, br-zoplog) for "up" events and
# updates DNS accordingly. It also runs on boot to ensure DNS is set correctly.
#
# Key features:
# - Monitors multiple interface types for network changes
# - Updates DNS only when the gateway actually changes
# - Provides detailed logging for troubleshooting
# - Handles both IPv4 and IPv6 configurations
# - Works with NetworkManager dispatcher system

INTERFACE="$1"
STATUS="$2"

# Act on ethernet interfaces and bridge when they come up
if [[ "$INTERFACE" =~ ^(eth|enp|br-zoplog) ]]; then
    # Only process "up" events for ethernet/bridge interfaces
    if [ "$STATUS" != "up" ]; then
        exit 0
    fi
else
    # For other interfaces, only process if no interface is specified (boot scenario)
    if [ -n "$INTERFACE" ]; then
        exit 0
    fi
fi

# Function to update DNS to current gateway
update_dns() {
    # Get the current default gateway IP
    GATEWAY_IP=$(ip route show default | awk '/default/ {print $3; exit}')

    if [ -n "$GATEWAY_IP" ]; then
        # Check current DNS configuration
        CURRENT_DNS=$(grep -E "^nameserver" /etc/resolv.conf | head -1 | awk '{print $2}')

        if [ "$CURRENT_DNS" != "$GATEWAY_IP" ]; then
            # Update DNS to use the gateway IP
            cat > /etc/resolv.conf << EOF
# Generated by zoplog-dns-dispatcher
nameserver $GATEWAY_IP
EOF

            logger "zoplog-dns-dispatcher: Updated DNS to gateway $GATEWAY_IP (was $CURRENT_DNS)"
        else
            logger "zoplog-dns-dispatcher: DNS already correct ($GATEWAY_IP)"
        fi
    else
        logger "zoplog-dns-dispatcher: No default gateway found"
    fi
}

# Update DNS
update_dns

# Boot-time check (when no interface/status provided)
if [ -z "$INTERFACE" ] || [ -z "$STATUS" ]; then
    logger "zoplog-dns-dispatcher: Boot-time DNS initialization"
    # Wait for network to settle
    sleep 10
    update_dns
fi

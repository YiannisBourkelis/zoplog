#!/usr/bin/env bash
# ZopLog Blocklist Restoration Script
# This script restores active blocklists from database on boot

set -euo pipefail

# Source database credentials from centralized config
if [[ -f "/etc/zoplog/database.conf" ]]; then
    # Parse INI format configuration
    DB_HOST=$(grep "^host" /etc/zoplog/database.conf | cut -d'=' -f2 | xargs)
    DB_USER=$(grep "^user" /etc/zoplog/database.conf | cut -d'=' -f2 | xargs)
    DB_PASS=$(grep "^password" /etc/zoplog/database.conf | cut -d'=' -f2 | xargs)
    DB_NAME=$(grep "^name" /etc/zoplog/database.conf | cut -d'=' -f2 | xargs)
else
    echo "Database configuration not found at /etc/zoplog/database.conf" >&2
    exit 1
fi

# Query active blocklists
ACTIVE_LISTS=$(mysql -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -sN -e "SELECT id FROM blocklists WHERE active='active'")

if [[ -z "$ACTIVE_LISTS" ]]; then
    echo "No active blocklists found"
    exit 0
fi

echo "Restoring active blocklists..."

# Apply firewall rules for each active blocklist
for list_id in $ACTIVE_LISTS; do
    echo "Applying blocklist $list_id..."
    /usr/local/sbin/zoplog-firewall-apply "$list_id" || echo "Failed to apply blocklist $list_id"
done

echo "Blocklist restoration completed"

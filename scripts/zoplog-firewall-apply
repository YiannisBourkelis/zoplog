#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "usage: $0 <blocklist_id>" >&2
  exit 2
fi

id="$1"
if ! [[ "$id" =~ ^[0-9]+$ ]]; then
  echo "invalid id: $id" >&2
  exit 2
fi

TABLE="zoplog"
SET_V4="zoplog-blocklist-${id}-v4"
SET_V6="zoplog-blocklist-${id}-v6"

# Load firewall interface from centralized config
FIREWALL_INTERFACE=""
if [[ -f "/etc/zoplog/zoplog.conf" ]]; then
  FIREWALL_INTERFACE=$(grep "^apply_to_interface" /etc/zoplog/zoplog.conf 2>/dev/null | cut -d'=' -f2 | xargs || echo "")
fi

# Fallback to eth0 if not configured
if [[ -z "$FIREWALL_INTERFACE" ]]; then
  FIREWALL_INTERFACE="eth0"
fi

# Load firewall rule timeout from centralized config
FIREWALL_TIMEOUT=""
if [[ -f "/etc/zoplog/zoplog.conf" ]]; then
  FIREWALL_TIMEOUT=$(grep "^firewall_rule_timeout" /etc/zoplog/zoplog.conf 2>/dev/null | cut -d'=' -f2 | xargs || echo "")
fi

# Ensure timeout is at least 1 second (default to 10800 seconds = 3 hours if not configured or invalid)
if [[ -z "$FIREWALL_TIMEOUT" || "$FIREWALL_TIMEOUT" -lt 1 ]]; then
  FIREWALL_TIMEOUT="10800"
fi
FIREWALL_TIMEOUT="timeout ${FIREWALL_TIMEOUT}s;"

echo "Applying firewall rules to internet-facing interface: $FIREWALL_INTERFACE"

# Ensure table and base chains exist
/usr/sbin/nft list table inet "$TABLE" >/dev/null 2>&1 || /usr/sbin/nft add table inet "$TABLE"
/usr/sbin/nft list chain inet "$TABLE" input   >/dev/null 2>&1 || /usr/sbin/nft add chain inet "$TABLE" input   '{ type filter hook input   priority 0; policy accept; }'
/usr/sbin/nft list chain inet "$TABLE" output  >/dev/null 2>&1 || /usr/sbin/nft add chain inet "$TABLE" output  '{ type filter hook output  priority 0; policy accept; }'
/usr/sbin/nft list chain inet "$TABLE" forward >/dev/null 2>&1 || /usr/sbin/nft add chain inet "$TABLE" forward '{ type filter hook forward priority 0; policy accept; }'

# Ensure sets exist
/usr/sbin/nft list set inet "$TABLE" "$SET_V4" >/dev/null 2>&1 || /usr/sbin/nft add set inet "$TABLE" "$SET_V4" "{ type ipv4_addr; flags interval; $FIREWALL_TIMEOUT }"
/usr/sbin/nft list set inet "$TABLE" "$SET_V6" >/dev/null 2>&1 || /usr/sbin/nft add set inet "$TABLE" "$SET_V6" "{ type ipv6_addr; flags interval; $FIREWALL_TIMEOUT }"

# Helper: check rule by unique comment
has_rule() {
  local chain="$1"; local comment="$2"
  /usr/sbin/nft list chain inet "$TABLE" "$chain" 2>/dev/null | grep -Fq "comment \"$comment\""
}

# Add rules idempotently with comments; LOG before REJECT
add_rule_if_missing() {
  local chain="$1"; shift
  local comment="$1"; shift
  if ! has_rule "$chain" "$comment"; then
    /usr/sbin/nft add rule inet "$TABLE" "$chain" "$@" comment "$comment"
  fi
}

# INPUT rules (traffic TO this system from the internet-facing interface)
add_rule_if_missing input "zoplog-bl-${id}-input-v4-log"  iifname "$FIREWALL_INTERFACE" ip  saddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-IN " level warn
add_rule_if_missing input "zoplog-bl-${id}-input-v4-reject" iifname "$FIREWALL_INTERFACE" ip  saddr @"$SET_V4" reject
add_rule_if_missing input "zoplog-bl-${id}-input-v6-log"  iifname "$FIREWALL_INTERFACE" ip6 saddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-IN " level warn
add_rule_if_missing input "zoplog-bl-${id}-input-v6-reject" iifname "$FIREWALL_INTERFACE" ip6 saddr @"$SET_V6" reject

# OUTPUT rules (traffic FROM this system to the internet-facing interface)
add_rule_if_missing output "zoplog-bl-${id}-output-v4-log"  oifname "$FIREWALL_INTERFACE" ip  daddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-OUT " level warn
add_rule_if_missing output "zoplog-bl-${id}-output-v4-reject" oifname "$FIREWALL_INTERFACE" ip  daddr @"$SET_V4" reject
add_rule_if_missing output "zoplog-bl-${id}-output-v6-log"  oifname "$FIREWALL_INTERFACE" ip6 daddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-OUT " level warn
add_rule_if_missing output "zoplog-bl-${id}-output-v6-reject" oifname "$FIREWALL_INTERFACE" ip6 daddr @"$SET_V6" reject

# FORWARD rules (traffic THROUGH this system via the internet-facing interface)
# Only block traffic going TO the internet (outbound) or coming FROM the internet (inbound)
add_rule_if_missing forward "zoplog-bl-${id}-forward-v4-saddr-log"  iifname "$FIREWALL_INTERFACE" ip  saddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-FWD " level warn
add_rule_if_missing forward "zoplog-bl-${id}-forward-v4-saddr-reject" iifname "$FIREWALL_INTERFACE" ip  saddr @"$SET_V4" reject
add_rule_if_missing forward "zoplog-bl-${id}-forward-v4-daddr-log"  oifname "$FIREWALL_INTERFACE" ip  daddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-FWD " level warn
add_rule_if_missing forward "zoplog-bl-${id}-forward-v4-daddr-reject" oifname "$FIREWALL_INTERFACE" ip  daddr @"$SET_V4" reject
add_rule_if_missing forward "zoplog-bl-${id}-forward-v6-saddr-log"  iifname "$FIREWALL_INTERFACE" ip6 saddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-FWD " level warn
add_rule_if_missing forward "zoplog-bl-${id}-forward-v6-saddr-reject" iifname "$FIREWALL_INTERFACE" ip6 saddr @"$SET_V6" reject
add_rule_if_missing forward "zoplog-bl-${id}-forward-v6-daddr-log"  oifname "$FIREWALL_INTERFACE" ip6 daddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-FWD " level warn
add_rule_if_missing forward "zoplog-bl-${id}-forward-v6-daddr-reject" oifname "$FIREWALL_INTERFACE" ip6 daddr @"$SET_V6" reject

# Auto-save rules after applying
"$(dirname "$0")/zoplog-nft-autosave" post-apply >/dev/null 2>&1 || true

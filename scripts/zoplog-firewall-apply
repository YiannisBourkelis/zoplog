#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "usage: $0 <blocklist_id>" >&2
  exit 2
fi

id="$1"
if ! [[ "$id" =~ ^[0-9]+$ ]]; then
  echo "invalid id: $id" >&2
  exit 2
fi

TABLE="zoplog"
SET_V4="zoplog-blocklist-${id}-v4"
SET_V6="zoplog-blocklist-${id}-v6"

# Ensure table and base chains exist
nft list table inet "$TABLE" >/dev/null 2>&1 || nft add table inet "$TABLE"
nft list chain inet "$TABLE" input  >/dev/null 2>&1 || nft add chain inet "$TABLE" input  '{ type filter hook input  priority 0; policy accept; }'
nft list chain inet "$TABLE" output >/dev/null 2>&1 || nft add chain inet "$TABLE" output '{ type filter hook output priority 0; policy accept; }'

# Ensure sets exist
nft list set inet "$TABLE" "$SET_V4" >/dev/null 2>&1 || nft add set inet "$TABLE" "$SET_V4" '{ type ipv4_addr; flags interval; }'
nft list set inet "$TABLE" "$SET_V6" >/dev/null 2>&1 || nft add set inet "$TABLE" "$SET_V6" '{ type ipv6_addr; flags interval; }'

# Helper: check rule by unique comment
has_rule() {
  local chain="$1"; local comment="$2"
  nft list chain inet "$TABLE" "$chain" 2>/dev/null | grep -Fq "comment \"$comment\""
}

# Add rules idempotently with comments; LOG before DROP
add_rule_if_missing() {
  local chain="$1"; shift
  local comment="$1"; shift
  if ! has_rule "$chain" "$comment"; then
    nft add rule inet "$TABLE" "$chain" "$@" comment "$comment"
  fi
}

# INPUT rules
add_rule_if_missing input  "zoplog-bl-${id}-input-v4-log"  ip  saddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-IN " level warn
add_rule_if_missing input  "zoplog-bl-${id}-input-v4-drop" ip  saddr @"$SET_V4" drop
add_rule_if_missing input  "zoplog-bl-${id}-input-v6-log"  ip6 saddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-IN " level warn
add_rule_if_missing input  "zoplog-bl-${id}-input-v6-drop" ip6 saddr @"$SET_V6" drop

# OUTPUT rules
add_rule_if_missing output "zoplog-bl-${id}-output-v4-log"  ip  daddr @"$SET_V4" log prefix "ZOPLOG-BLOCKLIST-OUT " level warn
add_rule_if_missing output "zoplog-bl-${id}-output-v4-drop" ip  daddr @"$SET_V4" drop
add_rule_if_missing output "zoplog-bl-${id}-output-v6-log"  ip6 daddr @"$SET_V6" log prefix "ZOPLOG-BLOCKLIST-OUT " level warn
add_rule_if_missing output "zoplog-bl-${id}-output-v6-drop" ip6 daddr @"$SET_V6" drop

# Auto-save rules after applying
/usr/local/sbin/zoplog-nft-autosave post-apply >/dev/null 2>&1 || true

#!/usr/bin/env bash
set -euo pipefail

# Delete an IP element from a specific nft set
# Usage: zoplog-nft-del-element <v4|v6> <set_name> <ip>

if [[ $# -ne 3 ]]; then
  echo "usage: $0 <v4|v6> <set_name> <ip>" >&2
  exit 2
fi

fam="$1"; setname="$2"; ip="$3"
TABLE="zoplog"

if [[ "$fam" != "v4" && "$fam" != "v6" ]]; then
  echo "family must be v4 or v6" >&2
  exit 2
fi

# Delete element if set exists
if nft list set inet "$TABLE" "$setname" >/dev/null 2>&1; then
  if [[ "$fam" == "v4" ]]; then
    nft delete element inet "$TABLE" "$setname" { "$ip" } 2>/dev/null || true
  else
    nft delete element inet "$TABLE" "$setname" { "$ip" } 2>/dev/null || true
  fi
fi

# Try to autosave without failing the command
"$(dirname "$0")/zoplog-nft-autosave" post-delete >/dev/null 2>&1 || true

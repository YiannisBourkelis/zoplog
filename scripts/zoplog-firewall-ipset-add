#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 2 ]]; then
  echo "usage: $0 <blocklist_id> <ip>" >&2
  exit 2
fi

id="$1"
ip="$2"

if ! [[ "$id" =~ ^[0-9]+$ ]]; then
  echo "invalid id: $id" >&2
  exit 2
fi

TABLE="zoplog"
SET_V4="zoplog-blocklist-${id}-v4"
SET_V6="zoplog-blocklist-${id}-v6"

# Ensure table and sets exist (no-op if present)
nft list table inet "$TABLE" >/dev/null 2>&1 || nft add table inet "$TABLE"
nft list set inet "$TABLE" "$SET_V4" >/dev/null 2>&1 || nft add set inet "$TABLE" "$SET_V4" '{ type ipv4_addr; flags interval; }'
nft list set inet "$TABLE" "$SET_V6" >/dev/null 2>&1 || nft add set inet "$TABLE" "$SET_V6" '{ type ipv6_addr; flags interval; }'

# Add element to the appropriate set; ignore duplicates
if [[ "$ip" == *:* ]]; then
  nft add element inet "$TABLE" "$SET_V6" { "$ip" } 2>/dev/null || true
else
  nft add element inet "$TABLE" "$SET_V4" { "$ip" } 2>/dev/null || true
fi

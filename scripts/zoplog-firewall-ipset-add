#!/usr/bin/env bash
set -euo pipefail

# Ensure predictable PATH for non-root/systemd environments
export PATH="/usr/sbin:/sbin:/usr/bin:/bin:${PATH:-}"

# Prefer absolute nft path if available
NFT_BIN="/usr/sbin/nft"
if [[ ! -x "$NFT_BIN" ]]; then
  NFT_BIN="$(command -v nft || true)"
fi
if [[ -z "${NFT_BIN:-}" ]]; then
  echo "Error: nft binary not found in PATH" >&2
  exit 127
fi

if [[ $# -ne 2 ]]; then
  echo "usage: $0 <blocklist_id> <ip>" >&2
  exit 2
fi

id="$1"
ip="$2"

if ! [[ "$id" =~ ^[0-9]+$ ]]; then
  echo "invalid id: $id" >&2
  exit 2
fi

TABLE="zoplog"
SET_V4="zoplog-blocklist-${id}-v4"
SET_V6="zoplog-blocklist-${id}-v6"

# Load firewall rule timeout from centralized config
FIREWALL_TIMEOUT=""
if [[ -f "/etc/zoplog/zoplog.conf" ]]; then
  FIREWALL_TIMEOUT=$(grep "^firewall_rule_timeout" /etc/zoplog/zoplog.conf 2>/dev/null | cut -d'=' -f2 | xargs || echo "")
fi

# Ensure timeout is at least 1 second (default to 10800 seconds = 3 hours if not configured or invalid)
if [[ -z "$FIREWALL_TIMEOUT" || "$FIREWALL_TIMEOUT" -lt 1 ]]; then
  FIREWALL_TIMEOUT="10800"
fi
FIREWALL_TIMEOUT="timeout ${FIREWALL_TIMEOUT}s"

# Ensure table and sets exist (no-op if present)
"$NFT_BIN" list table inet "$TABLE" >/dev/null 2>&1 || "$NFT_BIN" add table inet "$TABLE"
"$NFT_BIN" list set inet "$TABLE" "$SET_V4" >/dev/null 2>&1 || "$NFT_BIN" add set inet "$TABLE" "$SET_V4" "{ type ipv4_addr; flags interval; $FIREWALL_TIMEOUT }"
"$NFT_BIN" list set inet "$TABLE" "$SET_V6" >/dev/null 2>&1 || "$NFT_BIN" add set inet "$TABLE" "$SET_V6" "{ type ipv6_addr; flags interval; $FIREWALL_TIMEOUT }"

# Add element to the appropriate set; ignore duplicates
if [[ "$ip" == *:* ]]; then
  "$NFT_BIN" add element inet "$TABLE" "$SET_V6" { "$ip" } 2>/dev/null || true
else
  "$NFT_BIN" add element inet "$TABLE" "$SET_V4" { "$ip" } 2>/dev/null || true
fi

#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "usage: $0 <blocklist_id>" >&2
  exit 2
fi

id="$1"
if ! [[ "$id" =~ ^[0-9]+$ ]]; then
  echo "invalid id: $id" >&2
  exit 2
fi

TABLE="zoplog"
SET_V4="zoplog-blocklist-${id}-v4"
SET_V6="zoplog-blocklist-${id}-v6"

delete_rule_by_comment() {
  local chain="$1"; local comment="$2"
  local handle
  handle=$(nft -a list chain inet "$TABLE" "$chain" 2>/dev/null | awk -v c="comment \"$comment\"" '$0 ~ c { for(i=1;i<=NF;i++){ if($i=="handle"){ print $(i+1); exit } } }')
  if [[ -n "${handle:-}" ]]; then
    nft delete rule inet "$TABLE" "$chain" handle "$handle" || true
  fi
}

for chain in input output; do
  delete_rule_by_comment "$chain"  "zoplog-bl-${id}-${chain}-v4-log"
  delete_rule_by_comment "$chain"  "zoplog-bl-${id}-${chain}-v4-drop"
  delete_rule_by_comment "$chain"  "zoplog-bl-${id}-${chain}-v6-log"
  delete_rule_by_comment "$chain"  "zoplog-bl-${id}-${chain}-v6-drop"
done

# Destroy sets if present
nft list set inet "$TABLE" "$SET_V4" >/dev/null 2>&1 && nft delete set inet "$TABLE" "$SET_V4" || true
nft list set inet "$TABLE" "$SET_V6" >/dev/null 2>&1 && nft delete set inet "$TABLE" "$SET_V6" || true

# Auto-save rules after removing
"$(dirname "$0")/zoplog-nft-autosave" post-remove >/dev/null 2>&1 || true
